<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viewer Portal ‚Äì Privacy-Preserving LBS</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      padding: 20px;
      background-color: #f0f4f8;
    }
    #map { 
      height: 600px; 
      margin-top: 20px; 
      border: 1px solid #ccc; 
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    input, button { 
      padding: 10px 12px; 
      margin: 5px 0;
      border-radius: 8px;
      border: 1px solid #cbd5e0;
      box-sizing: border-box;
      width: 100%;
    }
    button {
      background-color: #4299e1;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.2s;
      margin-top: 10px;
    }
    button:hover {
      background-color: #3182ce;
    }
    .topbar { 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      margin-bottom: 20px;
    }
    .topbar h2 {
      color: #1a202c;
      font-size: 1.8rem;
      margin: 0;
    }
    .topbar button {
      width: auto;
      background-color: #ed8936;
      padding: 10px 20px;
    }
    .topbar button:hover {
      background-color: #dd6b20;
    }
    .control-section {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .control-section h3 {
      color: #2d3748;
      font-size: 1.25rem;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .control-section p {
      color: #4a5568;
      margin-bottom: 15px;
    }
    @media (min-width: 640px) {
      .input-group {
        display: flex;
        gap: 10px;
        align-items: stretch;
      }
      .input-group > * {
        flex-grow: 1;
        width: auto;
        margin: 0;
      }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h2>üìç Viewer Dashboard</h2>
    <button onclick="window.location.href='/'">‚¨Ö Go to Owner Page</button>
  </div>

  <div class="control-section">
    <h3>üîì Access Owner's Location</h3>
    <p>Enter your Viewer ID and the Owner ID to fetch location access (if authorized).</p>
    
    <div class="input-group">
      <input type="text" id="owner" placeholder="Owner ID (e.g. user123)" />
      <input type="text" id="viewer" placeholder="Viewer ID (e.g. agent456)" />
    </div>
    <input type="password" id="passphrase" placeholder="Passphrase (same as owner's)" />
    <button onclick="fetchOwnerLocation()">üîç Fetch Owner's Location</button>
  </div>

  <div id="map"></div>

  <script>
    let map;

    // ‚úÖ DYNAMIC API BASE URL - Automatically detects environment
    const API_BASE_URL = (() => {
      const hostname = window.location.hostname;
      
      // If running on localhost or 127.0.0.1, use localhost with port
      if (hostname === 'localhost' || hostname === '127.0.0.1') {
        return 'http://localhost:5000';
      }
      
      // If running on Render deployment
      if (hostname === 'plqp-project.onrender.com') {
        return 'https://plqp-project.onrender.com';
      }
      
      // Fallback to current origin for any other deployment
      return window.location.origin;
    })();

    console.log('üåê API Base URL:', API_BASE_URL);

    // ------------------- MAP SETUP -------------------
    function initMap(lat, lon) {
      console.log("%cüó∫ Initializing map...", "color: dodgerblue;");
      try {
        if (map) {
          console.log("%c‚ôª Removing previous map instance", "color: orange;");
          map.remove();
        }
        map = L.map("map").setView([lat, lon], 14);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
        console.log("%c‚úÖ Map initialized successfully", "color: green;");
      } catch (err) {
        console.error("‚ùå Error initializing map:", err);
      }
    }

    function addMarker(lat, lon, color, text) {
      try {
        console.log(`üìç Adding marker (${color}) at [${lat}, ${lon}] ‚Äî ${text}`);
        
        const icon = L.icon({
          iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
          shadowUrl: "https://unpkg.com/leaflet@1.9.3/dist/images/marker-shadow.png",
          iconSize: [25, 41],
          iconAnchor: [12, 41],
          popupAnchor: [1, -34],
          shadowSize: [41, 41]
        });

        if (isNaN(lat) || isNaN(lon)) {
          throw new Error(`Invalid coordinates: lat=${lat}, lon=${lon}`);
        }

        const marker = L.marker([lat, lon], { icon }).addTo(map);
        marker.bindPopup(text);
        console.log("%c‚úÖ Marker added successfully", "color: green;");
      } catch (err) {
        console.error(`‚ùå Failed to add marker at [${lat}, ${lon}] ‚Üí`, err.message);
      }
    }

    // ------------------- CRYPTO HELPERS -------------------
    function hexToBytes(hex) {
      if (!hex || typeof hex !== "string" || hex.length % 2 !== 0) {
        console.error("‚ö† Invalid hex input:", hex);
        return new Uint8Array();
      }
      const bytes = new Uint8Array(hex.length / 2);
      for (let i = 0; i < hex.length; i += 2)
        bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
      return bytes;
    }

    async function deriveKey(passphrase, saltHex) {
      console.log("%cüîë Deriving decryption key...", "color: cyan;");
      try {
        const enc = new TextEncoder();
        const keyMaterial = await window.crypto.subtle.importKey(
          "raw", enc.encode(passphrase), "PBKDF2", false, ["deriveKey"]
        );
        const salt = hexToBytes(saltHex);
        return await window.crypto.subtle.deriveKey(
          { name: "PBKDF2", salt, iterations: 200000, hash: "SHA-256" },
          keyMaterial,
          { name: "AES-GCM", length: 256 },
          false,
          ["decrypt"]
        );
      } catch (err) {
        console.error("‚ùå Error deriving key:", err);
        return null;
      }
    }

    async function decryptEnvelope(env, passphrase) {
      console.log("%cüì¶ Decrypting envelope...", "color: violet;", env);
      try {
        if (!env.salt_hex) {
          console.warn("‚ö† salt_hex missing from envelope, using default fallback salt.");
          env.salt_hex = Array.from(
            new TextEncoder().encode("plqp-salt-2025")
          ).map(b => b.toString(16).padStart(2, "0")).join("");
        }

        if (!env.nonce_hex || !env.tag_hex || !env.ciphertext_hex) {
          console.error("‚ùå Incomplete encryption envelope:", env);
          return null;
        }

        const nonce = hexToBytes(env.nonce_hex);
        const tag = hexToBytes(env.tag_hex);
        const ciphertext = hexToBytes(env.ciphertext_hex);
        const combined = new Uint8Array(ciphertext.length + tag.length);
        combined.set(ciphertext);
        combined.set(tag, ciphertext.length);

        const key = await deriveKey(passphrase, env.salt_hex);
        if (!key) return null;

        const plaintext = await window.crypto.subtle.decrypt(
          { name: "AES-GCM", iv: nonce }, 
          key, 
          combined
        );
        const decrypted = JSON.parse(new TextDecoder().decode(plaintext));
        console.log("%c‚úÖ Decryption successful:", "color: green;", decrypted);
        return decrypted;
      } catch (err) {
        console.error("‚ùå Error decrypting data:", err);
        alert("‚ùå Decryption failed. Check passphrase or server data.");
        return null;
      }
    }

    // ------------------- MAIN FETCH FUNCTION -------------------
    async function fetchOwnerLocation() {
      console.log("%cüîç Starting fetchOwnerLocation() process...", "color: orange;");
      
      const owner = document.getElementById("owner").value.trim();
      const viewer = document.getElementById("viewer").value.trim();
      const passphrase = document.getElementById("passphrase").value.trim();

      if (!owner || !viewer || !passphrase) {
        alert("‚ö† Please enter owner ID, viewer ID, and passphrase.");
        return;
      }

      console.log(`Attempting to fetch location: Owner=${owner}, Viewer=${viewer}`);

      try {
        const res = await fetch(`${API_BASE_URL}/view_location`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ owner, viewer }),
        });

        const data = await res.json();
        console.log("%cüì® Received response:", "color: limegreen;", data);

        if (data.error) {
          alert("‚ùå " + data.error);
          return;
        }

        // üîì Decrypt received encrypted data
        const decrypted = await decryptEnvelope(data.enc_data, passphrase);
        if (!decrypted) {
          console.warn("‚ö† Decryption returned null.");
          return;
        }

        if (!decrypted.center) {
          alert("‚ö† No valid location found for owner.");
          return;
        }

        // ‚úÖ Only show owner's main (real) location
        const center = decrypted.center;
        console.log("%cüìç Owner's center location:", "color: yellow;", center);
        
        initMap(center.lat, center.lon);
        addMarker(center.lat, center.lon, "red", "üìç Owner's Current Location");

        alert("‚úÖ Access verified ‚Äî displaying owner's live location.");
      } catch (err) {
        console.error("‚ùå Error fetching location:", err);
        alert("‚ùå Failed to fetch owner's location. Ensure access is active and server is reachable.");
      }
    }

    // Initialize map on page load with a default location
    document.addEventListener("DOMContentLoaded", () => {
      console.log("%cüöÄ Page loaded - initializing default map view", "color: cyan;");
      initMap(37.422, -122.084); // Default to Google HQ
    });
  </script>
</body>
</html>